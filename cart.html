<!DOCTYPE html>
<html lang="ar" dir="rtl" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>يوسف للبصريات - سلة التسوق</title>
  <meta name="description" content="راجع المنتجات التي أضفتها إلى السلة واستعد لإتمام الطلب بسهولة وأمان. يوسف للبصريات يضمن لك تجربة تسوق مميزة.">
  <meta name="keywords" content="سلة تسوق, نظارات طبية, عدسات لاصقة, يوسف للبصريات, الشراء أونلاين, Bootstrap">
  
  <!-- إضافة وسوم منع التخزين المؤقت -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Custom Styles -->
  <style>
    :root {
      --yello: #F2B705;
      --yello-dark: #e0a800;
      --yello-rgb: 242, 183, 5;
      --success-color: #198754;
      --danger-color: #dc3545;
	        --y-secondary: #F2B705;

    }

    * {
      font-family: 'Tajawal', sans-serif;
      box-sizing: border-box;
    }
    
    body {
      min-height: 100vh;
      padding-top: 70px; /* To offset fixed navbar */
      transition: background-color 0.3s ease, color 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    main {
        flex-grow: 1;
    }

    /* Custom Loader */
    .loader-container {
      position: fixed;
      inset: 0;
      z-index: 1056;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(var(--bs-body-bg-rgb), 0.7);
      backdrop-filter: blur(4px);
    }
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--yello);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .btn-yello {
        background-image: linear-gradient(to top, #f2b705, #f5c431);
        border: none;
        transition: all 0.3s ease;
        color: #000;
        font-weight: bold;
    }
    .btn-yello:hover, .btn-yello:focus {
        background-color: var(--yello-dark);
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(var(--yello-rgb), 0.25);
    }
    .btn-yello:disabled {
        background-color: #f2b8058a;
        background-image: none;
        cursor: not-allowed;
    }
     .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(var(--yello-rgb), 0.3);
        border-color: var(--yello);
    }

    /* Order Confirmation Animation */
    .order-confirmation .fa-check-circle {
      font-size: 5rem;
      color: var(--success-color);
      margin-bottom: 1.5rem;
      animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-10px); }
    }
    .tracking-info {
        background-color: var(--bs-tertiary-bg);
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: bold;
        display: inline-block;
        border: 1px dashed var(--bs-border-color);
    }

    /* --- Progress Steps --- */
    .progress-steps { 
        margin-top: 1rem !important;
        margin-bottom: 2rem !important;
    }
    .steps-container { display: flex; justify-content: space-between; position: relative; max-width: 400px; margin: 0 auto; }
    .step { display: flex; flex-direction: column; align-items: center; z-index: 2; background: var(--bs-body-bg); padding: 0 0.5rem; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bs-tertiary-bg); display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; font-weight: bold; color: var(--bs-secondary-color); border: 3px solid var(--bs-tertiary-bg); transition: all 0.4s ease; }
    .step.active .step-circle { border-color: var(--yello); color: var(--yello); }
    .step.completed .step-circle { background-color: var(--success-color); border-color: var(--success-color); color: white; }
    .step-label { font-weight: 500; color: var(--bs-secondary-color); transition: all 0.3s ease; }
    .step.active .step-label, .step.completed .step-label { color: var(--bs-body-color); font-weight: 700; }
    .progress-bar-container { position: absolute; top: 20px; left: 0; right: 0; height: 4px; background-color: var(--bs-tertiary-bg); z-index: 1; margin: 0 20px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success-color), var(--yello)); width: 0%; transition: width 0.5s ease; }
    
    /* --- Cart Item Layout --- */
    .cart-item {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        border-bottom: 1px solid var(--bs-border-color-translucent);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    .cart-item-image { 
        width: 100px; 
        height: 100px; 
        object-fit: cover; 
        border-radius: 0.5rem; 
        border: 1px solid var(--bs-border-color);
        order: 2;
    }
    .cart-item-details {
        flex-grow: 1;
        order: 1;
    }
    .price-breakdown {
        font-size: 0.85rem;
        color: var(--bs-secondary-color);
        background-color: var(--bs-tertiary-bg);
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-top: 0.5rem;
    }
    .quantity-control {
      display: flex;
      align-items: center;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--bs-border-color);
    }
    .quantity-btn {
      background-color: #f0f0f0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      border: none;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .quantity-input {
      width: 50px;
      text-align: center;
      border: none;
      background: transparent;
      font-weight: bold;
      -moz-appearance: textfield;
    }
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .remove-item {
        background: transparent;
        border: none;
        color: var(--danger-color);
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    .remove-item:hover {
        opacity: 1;
    }
    
    /* Responsive Prescription Table */
    .prescription-container {
        background-color: var(--bs-body-bg);
        padding: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--bs-border-color);
        font-size: 0.72rem;
    }
    .prescription-container .table {
        line-height: 1.2;
    }
    .prescription-container .table th,
    .prescription-container .table td {
        padding: 0.25rem;
    }
    .prescription-container .table input {
        height: 28px;
        font-size: 0.8rem;
        padding: 0.25rem;
    }
    /* Larger screens */
    @media (min-width: 768px) {
        .prescription-container {
            font-size: 0.9rem;
            padding: 1rem;
        }
        .prescription-container .table th,
        .prescription-container .table td {
            padding: 0.5rem;
        }
        .prescription-container .table input {
            height: 38px;
            font-size: 1rem;
        }
    }

    /* Payment Method Selection */
    .payment-option { 
      border: 2px solid var(--bs-border-color); 
      cursor: pointer; 
      transition: all 0.2s ease-in-out; 
    }
    .payment-option:hover { 
      border-color: var(--yello-dark); 
      transform: translateY(-2px); 
    }
    .payment-option.active { 
      border-color: var(--yello); 
      background-color: var(--bs-tertiary-bg); 
      box-shadow: 0 4px 12px rgba(var(--yello-rgb), 0.1); 
    }
    .payment-option input[type="radio"] { 
      accent-color: var(--yello); 
    }
    
    /* Toast Notification CSS */
    .toast-notification {
        position: fixed;
        left: 50%;
        top: 80px;
        transform: translate(-50%, -150%); /* Start off-screen */
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: #fff;
        font-weight: bold;
        z-index: 2000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        opacity: 0;
        visibility: hidden;
        transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
    .toast-notification.show {
        transform: translate(-50%, 0); /* Slide into view */
        opacity: 1;
        visibility: visible;
    }
    .toast-notification.success { background-color: var(--success-color); }
    .toast-notification.error { background-color: var(--danger-color); }
    .toast-notification.info { background-color: #0dcaf0; }
    .toast-close-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        line-height: 1;
        opacity: 0.8;
    }
    .toast-close-btn:hover { opacity: 1; }
    
    /* --- Footer Styles --- */
    .site-footer {
        background: linear-gradient(to right, #000, #1a1a1a);
        color: #fff;
        padding-top: 4rem;
        padding-bottom: 2rem;
        font-family: 'Tajawal', sans-serif;
    }
    .site-footer h5 {
        font-family: 'Cairo', sans-serif;
        font-weight: 700;
        color: #fff;
        margin-bottom: 1.5rem;
    }
    .site-footer p {
        color: #adb5bd;
    }
    .site-footer .footer-links {
        list-style: none;
        padding: 0;
    }
    .site-footer .footer-links li {
        margin-bottom: 0.75rem;
    }
    .site-footer .footer-links a {
        color: #adb5bd;
        text-decoration: none;
        transition: color 0.2s;
    }
    .site-footer .footer-links a:hover {
        color: var(--yello);
    }
    .site-footer .social-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #343a40;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        transition: background-color 0.2s;
    }
    .site-footer .social-icon:hover {
        background-color: var(--yello);
        color: #000;
    }
    .site-footer .footer-bottom {
        border-top: 1px solid #495057;
        padding-top: 1.5rem;
        margin-top: 2rem;
        color: #6c757d;
    }
    .site-footer .footer-bottom a {
        color: var(--yello);
        text-decoration: none;
    }
    .site-footer .footer-bottom a:hover {
        text-decoration: underline;
    }
    .site-footer .form-control {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: #fff;
    }
    .site-footer .form-control::placeholder {
        color: #adb5bd;
    }


    /* Dark Mode Overrides */
    [data-bs-theme="dark"] {
      --bs-body-bg: #0f172a;
      --bs-body-color: #e2e8f0;
      --bs-border-color: #334155;
      --bs-tertiary-bg: #1e293b;
      --bs-secondary-color: #9ca3af;
      --bs-emphasis-color: #fff;
    }
    [data-bs-theme="dark"] .quantity-btn { background-color: #334155; color: #e5e7eb; }
    [data-bs-theme="dark"] .quantity-btn:hover { background-color: #3e4c63; }
    [data-bs-theme="dark"] .payment-option.active { background-color: #334155; }
    [data-bs-theme="dark"] .prescription-container { background-color: var(--bs-tertiary-bg); }
    [data-bs-theme="dark"] .site-footer {
        background: linear-gradient(to right, #0f172a, #1e293b);
    }
    [data-bs-theme="dark"] .site-footer .footer-bottom {
        border-top-color: #334155;
        color: #9ca3af;
    }
    [data-bs-theme="dark"] .site-footer .social-icon {
        background-color: #334155;
    }
    [data-bs-theme="dark"] .site-footer .form-control {
        background-color: rgba(51, 65, 85, 0.5);
        border-color: rgba(51, 65, 85, 1);
    }
/* === Bottom Mobile Navigation Styles (Improved Look) === */
/* === Modern Bottom Navigation Bar === */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 80px;
    background-color: #ffffff;
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 1040;
    padding: 0 15px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
    border: none;
}

[data-bs-theme="dark"] .bottom-nav {
    background-color: #1a2235;
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
}

.bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: var(--y-light-text);
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    width: 70px;
    height: 100%;
    padding-top: 15px;
}

.bottom-nav-item i {
    font-size: 1.6rem;
    margin-bottom: 5px;
    transition: all 0.3s ease;
}

[data-bs-theme="dark"] .bottom-nav-item {
    color: var(--y-dark-header);
}

/* العنصر النشط - تصميم مشابه للصورة */
.bottom-nav-item.active {
    color: var(--y-secondary);
}

.bottom-nav-item.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 3px;
    background-color: var(--y-secondary);
    border-radius: 3px;
}

.bottom-nav-item.active i {
    transform: scale(1.1);
}

.bottom-nav-item.active span {
    font-weight: 600;
}

/* تأثيرات التحويم */
.bottom-nav-item:hover {
    color: var(--y-secondary);
    transform: translateY(-3px);
}

/* شارة الإشعارات - تصميم عصري */
.bottom-nav-item .badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.6em;
    padding: 0.2em 0.4em;
    border-radius: 50px;
    background-color: #ff4757;
    color: white;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--y-light-card);
}

[data-bs-theme="dark"] .bottom-nav-item .badge {
    border-color: #1a2235;
}

/* تعديل الحشو السفلي للجسم */
body {
    padding-bottom: 80px;
}

@media (min-width: 992px) {
    body {
        padding-bottom: 0;
    }
    .bottom-nav {
        display: none;
    }
}
  </style>
</head>

<body class="bg-body-tertiary">
  <!-- LOADER -->
  <div id="pageLoader" class="loader-container bg-body">
      <div class="loader"></div>
  </div>

  <!-- Toast Notification Container -->
  <div id="toastNotification" class="toast-notification">
      <span id="toastMessage"></span>
      <button id="toastCloseBtn" class="toast-close-btn">&times;</button>
  </div>
  
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="images/logo.png" alt="Logo" style="max-height: 40px; width: auto;">
      </a>
      <div class="d-flex align-items-center">
        <button id="darkModeToggle" class="btn btn-link text-decoration-none me-2 text-body">
          <i class="fas fa-moon d-none" id="darkModeIcon"></i>
          <i class="fas fa-sun" id="lightModeIcon"></i>
        </button>
        <a href="store.html" class="btn btn-link text-decoration-none text-body fs-5">
          <i class="fas fa-store"></i>
        </a>
        <a href="cart.html" class="btn btn-link text-decoration-none text-body fs-5 position-relative">
          <i class="fas fa-shopping-cart"></i>
          <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-yello text-black">0</span>
        </a>
      </div>
    </div>
  </nav>

<nav class="bottom-nav d-lg-none">
    <a href="index.html" class="bottom-nav-item">
      <i class="fas fa-home"></i>
      <span>الرئيسية</span>
    </a>
    <a href="store.html" class="bottom-nav-item">
      <i class="fas fa-store"></i>
      <span>المتجر</span>
    </a>
    <a href="cart.html" class="bottom-nav-item active">
      <i class="fas fa-shopping-cart"></i>
      <span>السلة</span>
      <span id="cartCountBottomNav" class="badge rounded-pill bg-danger text-white" style="display: none;">0</span>
    </a>
    <a href="track.html" class="bottom-nav-item">
      <i class="fas fa-truck-fast"></i>
      <span>تتبع</span>
    </a>
    <a href="blog.html" class="bottom-nav-item">
      <i class="fas fa-newspaper"></i>
      <span>المدونة</span>
    </a>
  </nav>
  <!-- ORDER CONFIRMATION SCREEN -->
  <div id="orderConfirmation" class="container py-5 text-center order-confirmation" style="display: none;">
    <i class="fas fa-check-circle"></i>
    <h2 class="fw-bold">تم استلام طلبك بنجاح!</h2>
    <p class="fs-5" id="confirmationMessage">شكراً لطلبك من يوسف للبصريات. تم توجيهك إلى واتساب لإرسال تفاصيل الطلب.</p>
    <div class="tracking-info my-4">
      رقم تتبع طلبك هو: <span id="trackingIdDisplay" class="font-monospace"></span>
    </div>
    <div id="confirmationButtons" class="mt-4 d-flex flex-column flex-sm-row justify-content-center align-items-center gap-3">
        <a id="trackOrderBtn" href="#" class="btn btn-dark btn-lg">
            <i class="fas fa-truck me-2"></i> متابعة حالة الطلب
        </a>
        <a id="backToStoreBtn" href="store.html" class="btn btn-yello btn-lg">
            <i class="fas fa-arrow-left me-2"></i> العودة للمتجر
        </a>
    </div>
  </div>


  <!-- MAIN CART CONTENT -->
  <main id="mainCartContent" class="container py-5">
    
    <!-- PROGRESS STEPS -->
    <div class="progress-steps">
      <div class="steps-container">
        <div class="step active" id="step1">
          <div class="step-circle"><i class="fas fa-shopping-cart"></i></div>
          <div class="step-label">عرض السلة</div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-fill"></div>
        </div>
        <div class="step" id="step2">
          <div class="step-circle"><i class="fas fa-truck"></i></div>
          <div class="step-label">معلومات الشحن</div>
        </div>
      </div>
    </div>

    <!-- EMPTY CART MESSAGE -->
    <div id="emptyCartMessage" class="text-center py-5" style="display: none;">
        <i class="fas fa-shopping-cart fa-4x text-secondary mb-4"></i>
        <h2 class="fw-bold h1">سلة التسوق فارغة</h2>
        <p class="mb-4 fs-5">لم تقم بإضافة أي منتجات إلى السلة بعد.</p>
        <a href="store.html" class="btn btn-yello btn-lg">
            <i class="fas fa-store me-2"></i> تصفح المنتجات
        </a>
    </div>
    
    <!-- STEP 1: CART DETAILS -->
    <div id="cartStep1" class="card shadow-sm mb-4">
      <div class="card-header bg-body-tertiary p-3">
        <h2 class="h5 mb-0 fw-bold d-flex align-items-center">
          <i class="fas fa-shopping-cart me-2 text-yello"></i>
          سلة التسوق
        </h2>
      </div>
      <div id="cartItems" class="card-body p-4"></div>
      <div class="card-footer p-4">
        <h3 class="h6 fw-bold mb-3 d-flex align-items-center">
          <i class="fas fa-receipt me-2 text-yello"></i>
          ملخص الطلب
        </h3>
        <div class="input-group mb-4">
          <input type="text" id="promoCode" placeholder="أدخل كود الخصم هنا" class="form-control form-control-lg">
          <button id="applyPromo" class="btn btn-yello">
            <i class="fas fa-tag me-2"></i> تطبيق
          </button>
        </div>
        <div id="promoMessage" class="d-none mb-4 p-3 rounded-3"></div>
        <div id="step1SummaryDetails"></div>
        <div class="d-grid gap-2 mt-4">
          <button id="proceedToShipping" class="btn btn-yello btn-lg">
            <i class="fas fa-truck me-2"></i> المتابعة إلى معلومات الشحن
          </button>
          <a href="store.html" class="btn btn-link text-yello text-decoration-none">
            <i class="fas fa-arrow-left me-2"></i> العودة للمتجر
          </a>
        </div>
      </div>
    </div>

    <!-- STEP 2: SHIPPING INFO -->
    <div id="cartStep2" class="d-none card shadow-sm">
      <div class="card-header bg-body-tertiary p-3">
        <h2 class="h5 mb-0 fw-bold d-flex align-items-center">
          <i class="fas fa-truck me-2 text-yello"></i>
          معلومات الشحن
        </h2>
      </div>
      <div class="card-body p-4">
        <form id="customerForm" novalidate>
          <h3 class="h6 fw-bold mb-3 d-flex align-items-center">
              <i class="fas fa-user me-2 text-yello"></i>
              المعلومات الشخصية
          </h3>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="customerName" class="form-label">الاسم بالكامل <span class="text-danger">*</span></label>
              <input type="text" id="customerName" required class="form-control" placeholder="أدخل اسمك بالكامل">
            </div>
            <div class="col-md-6">
              <label for="customerPhone" class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
              <input type="tel" id="customerPhone" required class="form-control" placeholder="مثال: 01012345678">
            </div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="h6 fw-bold mb-0 d-flex align-items-center">
                <i class="fas fa-map-marker-alt me-2 text-yello"></i>
                عنوان الشحن
              </h3>
              <button type="button" id="locateMeBtn" class="btn btn-dark btn-sm d-flex align-items-center">
                <i class="fas fa-crosshairs me-2"></i>
                استخدام موقعي الحالي
              </button>
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="customerGovernorate" class="form-label">المحافظة <span class="text-danger">*</span></label>
              <select id="customerGovernorate" required class="form-select">
                <option value="">اختر المحافظة</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="customerDistrict" class="form-label">المنطقة/الحي <span class="text-danger">*</span></label>
              <select id="customerDistrict" required class="form-select" disabled>
                <option value="">اختر المحافظة أولاً</option>
              </select>
            </div>
            <div class="col-12">
              <label for="customerAddress" class="form-label">العنوان بالتفصيل <span class="text-danger">*</span></label>
              <textarea id="customerAddress" required rows="3" class="form-control" placeholder="اسم الشارع، رقم العمارة، الشقة، وأي علامة مميزة"></textarea>
            </div>
          </div>

          <h3 class="h6 fw-bold mb-3 d-flex align-items-center">
              <i class="fas fa-credit-card me-2 text-yello"></i>
              طريقة الدفع <span class="text-danger ms-1">*</span>
          </h3>
          <div class="d-flex flex-column gap-3 mb-4" id="paymentMethodsContainer">
              <div class="p-3 rounded-3 payment-option" onclick="this.querySelector('input').click()">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="paymentInstaPay" value="InstaPay" required>
                  <label class="form-check-label w-100" for="paymentInstaPay">
                    <span class="fw-bold d-block">انستا باي</span>
                    <small class="text-secondary">تحويل فوري عبر تطبيق انستا باي</small>
                  </label>
                </div>
                <div id="instaPayDetails" class="d-none mt-2 ms-4">
                  <input type="text" id="instaPayHandle" placeholder="اسم المستخدم @instapay أو رقم الهاتف" class="form-control">
                </div>
              </div>
              <div class="p-3 rounded-3 payment-option" onclick="this.querySelector('input').click()">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="paymentEWallet" value="E-Wallet">
                  <label class="form-check-label w-100" for="paymentEWallet">
                    <span class="fw-bold d-block">محفظة إلكترونية</span>
                    <small class="text-secondary">فودافون كاش، أورانج كاش، وغيرها</small>
                  </label>
                </div>
                 <div id="eWalletDetails" class="d-none mt-2 ms-4">
                  <input type="text" id="eWalletNumber" placeholder="رقم الهاتف المرتبط بالمحفظة" class="form-control">
                </div>
              </div>
              <div class="p-3 rounded-3 payment-option active" onclick="this.querySelector('input').click()">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCash" value="Cash" checked>
                  <label class="form-check-label w-100" for="paymentCash">
                    <span class="fw-bold d-block">كاش عند الاستلام</span>
                    <small class="text-secondary">الدفع عند استلام الطلب</small>
                  </label>
                </div>
              </div>
          </div>
          
         <div class="mb-4">
            <h3 class="h6 fw-bold mb-3 d-flex align-items-center">
                <i class="fas fa-file-medical me-2 text-secondary"></i>
                مقاس النظر (يمكن إرساله عن طريق الواتساب)
            </h3>
            <div class="prescription-container">
                <div class="table-responsive">
                    <table class="table table-bordered text-center m-0">
                        <thead>
                            <tr>
                                <th colspan="8" class="p-1" style="font-size: 0.75em;">يمكنك ترك هذه الحقول فارغة وإرسال صورة الكشف عبر واتساب</th>
                            </tr>
                            <tr>
                                <th class="p-1" style="font-size: 0.75em;">IPD</th>
                                <th colspan="3" class="p-1" style="font-size: 0.75em;">Left eye</th>
                                <th colspan="3" class="p-1" style="font-size: 0.75em;">Right eye</th>
                                <th class="p-1" style="font-size: 0.75em;"></th>
                            </tr>
                            <tr>
                                <th class="p-1" style="font-size: 0.75em;"></th>
                                <th class="p-1" style="font-size: 0.75em;">Axis</th>
                                <th class="p-1" style="font-size: 0.75em;">Cylinder</th>
                                <th class="p-1" style="font-size: 0.75em;">Sphere</th>
                                <th class="p-1" style="font-size: 0.75em;">Axis</th>
                                <th class="p-1" style="font-size: 0.75em;">Cylinder</th>
                                <th class="p-1" style="font-size: 0.75em;">Sphere</th>
                                <th class="p-1" style="font-size: 0.75em;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-0"><input type="text" id="ipdDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftAxisDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftCylinderDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftSphereDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightAxisDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightCylinderDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightSphereDistance" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-1 fw-bold" style="font-size: 0.75em;">Distance</td>
                            </tr>
                            <tr>
                                <td class="p-0"><input type="text" id="ipdReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftAxisReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftCylinderReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="leftSphereReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightAxisReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightCylinderReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-0"><input type="text" id="rightSphereReading" class="form-control form-control-sm p-0 text-center" style="font-size: 0.75em; height: 25px;" placeholder="--"></td>
                                <td class="p-1 fw-bold" style="font-size: 0.75em;">Reading</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
          
          <div class="mb-4">
              <label for="customerNotes" class="form-label">ملاحظات إضافية</label>
              <textarea id="customerNotes" rows="2" class="form-control" placeholder="أي ملاحظات إضافية تريد إضافتها للطلب"></textarea>
          </div>

          <div class="mt-4 border-top pt-4">
            <div id="finalSummary" class="card card-body bg-body-tertiary mb-4"></div>
            
            <div id="orderError" class="alert alert-danger d-none" role="alert"></div>

            <div class="d-grid gap-2">
             <button type="button" id="sendOrderBtn" class="btn btn-yello btn-lg d-flex align-items-center justify-content-center">
               <span class="btn-text"><i class="fas fa-check-circle me-2"></i> تأكيد وإرسال الطلب</span>
               <span class="spinner-border spinner-border-sm ms-2 d-none btn-loader" role="status" aria-hidden="true"></span>
             </button>
             <button type="button" id="backToCart" class="btn btn-link text-yello text-decoration-none">
               <i class="fas fa-arrow-left me-2"></i> العودة إلى السلة
             </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="site-footer mt-auto">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                <h5>يوسف للبصريات</h5>
                <p>حيث تلتقي الرؤية بالأناقة. نقدم أفضل الحلول البصرية مع أحدث التصاميم العالمية.</p>
                <div class="d-flex gap-2">
                    <a href="https://www.facebook.com/share/193kMj5kWg/" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/youalhassan?igsh=N2djbHd2azV6aGJx" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>
                    <a href="https://wa.me/201092837489" target="_blank" class="social-icon"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                <h5>روابط سريعة</h5>
                <ul class="footer-links">
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="store.html">المتجر</a></li>
                    <li><a href="index.html#founder">من نحن</a></li>
                    <li><a href="index.html#services">خدماتنا</a></li>
                    <li><a href="index.html#contact">اتصل بنا</a></li>
                </ul>
            </div>
            <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
                <h5>سياساتنا</h5>
                <ul class="footer-links">
                    <li><a href="privacy.html">سياسة الخصوصية</a></li>
                    <li><a href="returns.html">سياسة الاستبدال والاسترجاع</a></li>
                    <li><a href="terms.html">الشروط والأحكام</a></li>
                    <li><a href="track.html">تتبع طلبك</a></li>
                </ul>
            </div>
            <div class="col-lg-3 col-md-6">
                <h5>اشترك في النشرة البريدية</h5>
                <p>اشترك لتصلك أحدث العروض والتخفيضات.</p>
                <form>
                    <div class="input-group">
                        <input type="email" class="form-control" placeholder="بريدك الإلكتروني">
                        <button class="btn btn-yello" type="button"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </form>
            </div>
        </div>
        <div class="footer-bottom text-center">
            <p class="mb-0">&copy; 2025 جميع الحقوق محفوظة | يوسف للبصريات</p>
            <p class="mb-0 mt-1 small">
                تصميم وتطوير بواسطة <a href="https://www.facebook.com/share/19LSLJAU8J/" target="_blank">Ehab Mohamad Fkrey</a>
            </p>
        </div>
    </div>
  </footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDoc, doc, addDoc, runTransaction, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAlrzDNrFGxE-tihV6cAj_6r77RcFW8FgA",
        authDomain: "youssef-optics.firebaseapp.com",
        projectId: "youssef-optics",
        storageBucket: "youssef-optics.appspot.com",
        messagingSenderId: "956537200762",
        appId: "1:956537200762:web:bfbb1ca17debc2b30a1bc3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
        const WHATSAPP_NUMBER = '201092837489';
        const districts = {
          'القاهرة': ['مصر الجديدة', 'مدينة نصر', 'المعادي', 'حلوان', 'عين شمس', 'المطرية', 'شبرا', 'السيدة زينب', 'وسط البلد', 'التجمع (القاهرة الجديدة)', 'المرج', 'البساتين', 'دار السلام', 'الخليفة', 'الزاوية الحمراء', 'روض الفرج', 'منشية ناصر', 'السلام', 'الزيتون'],
          'الجيزة': ['الدقي', 'المهندسين', 'العجوزة', 'الهرم', 'فيصل', 'العمرانية', 'بولاق الدكرور', 'إمبابة', 'الوراق', 'البدرشين', 'الصف', 'أطفيح', 'العياط', 'الواحات البحرية', 'الشيخ زايد', '6 أكتوبر'],
          'الإسكندرية': ['سيدي جابر', 'سموحة', 'الرمل', 'العجمي', 'المنتزه', 'المنشية', 'ميامي', 'المعمورة', 'الدخيلة', 'العامرية', 'برج العرب', 'كرموز', 'باب شرق'],
          'الدقهلية': ['المنصورة', 'ميت غمر', 'دكرنس', 'السنبلاوين', 'أجا', 'المنزلة', 'بلقاس', 'طلخا', 'شبرا', 'منية النصر', 'نبروه', 'تمى الأمديد'],
          'الشرقية': ['الزقازيق', 'العاشر من رمضان', 'بلبيس', 'ههيا', 'أبو حماد', 'كفر صقر', 'فاقوس', 'منيا القمح', 'أبو كبير', 'الحسينية', 'مشتول السوق', 'ديرب نجم', 'الإبراهيمية', 'القنايات'],
          'القليوبية': ['بنها', 'طوخ', 'شبين القناطر', 'القناطر الخيرية', 'الخانكة', 'قليوب', 'كفر شكر', 'العبور', 'الخصوص', 'شبرا الخيمة'],
          'البحيرة': ['دمنهور', 'كفر الدوار', 'رشيد', 'إدكو', 'أبو حمص', 'المحمودية', 'إيتاي البارود', 'حوش عيسى', 'كوم حمادة', 'بدر', 'النوبارية', 'وادي النطرون'],
          'الغربية': ['طنطا', 'المحلة الكبرى', 'كفر الزيات', 'سمنود', 'زفتى', 'بسيون', 'السنطة', 'قطور'],
          'كفر الشيخ': ['كفر الشيخ', 'دسوق', 'سيدي سالم', 'فوه', 'الحامول', 'بلطيم', 'بيلا', 'مطوبس', 'الرياض'],
          'المنوفية': ['شبين الكوم', 'منوف', 'قويسنا', 'تلا', 'الشهداء', 'أشمون', 'الباجور', 'سرس الليان', 'بركة السبع'],
          'دمياط': ['دمياط', 'رأس البر', 'عزبة البرج', 'كفر سعد', 'كفر البطيخ', 'فارسكور', 'الزرقا', 'الروضة'],
          'بورسعيد': ['حي الشرق', 'حي العرب', 'حي المناخ', 'حي الضواحي', 'حي الزهور', 'حي الجنوب', 'حي غرب'],
          'الإسماعيلية': ['حي أول', 'حي ثان', 'حي ثالث', 'التل الكبير', 'فايد', 'القنطرة شرق', 'القنطرة غرب', 'أبو صوير'],
          'السويس': ['حي السويس', 'حي الأربعين', 'حي عتاقة', 'حي فيصل', 'حي الجناين'],
          'بني سويف': ['بني سويف', 'ناصر', 'الواسطى', 'الفشن', 'ببا', 'سمسطا', 'إهناسيا'],
          'الفيوم': ['الفيوم', 'طامية', 'سنورس', 'إطسا', 'يوسف الصديق', 'أبشواي'],
          'المنيا': ['المنيا', 'بني مزار', 'مطاي', 'سمالوط', 'أبو قرقاص', 'ملوي', 'دير مواس', 'العدوة'],
          'أسيوط': ['أسيوط', 'ديروط', 'القوصية', 'منفلوط', 'البداري', 'الغنايم', 'ساحل سليم', 'أبنوب', 'أبو تيج'],
          'سوهاج': ['سوهاج', 'أخميم', 'طهطا', 'طما', 'جرجا', 'البلينا', 'المراغة', 'دار السلام', 'المنشاة'],
          'قنا': ['قنا', 'دشنا', 'نجع حمادي', 'نقادة', 'قوص', 'الوقف', 'فرشوط', 'أبوتشت'],
          'الأقصر': ['الأقصر', 'الزينية', 'البياضية', 'إسنا', 'أرمنت', 'الطود'],
          'أسوان': ['أسوان', 'كوم أمبو', 'دراو', 'إدفو', 'نصر النوبة', 'أبو سمبل'],
          'شمال سيناء': ['العريش', 'بئر العبد', 'الشيخ زويد', 'رفح', 'الحسنة', 'نخل'],
          'جنوب سيناء': ['الطور', 'شرم الشيخ', 'دهب', 'نويبع', 'طابا', 'سانت كاترين', 'أبو رديس', 'أبو زنيمة'],
          'مطروح': ['مرسى مطروح', 'الحمام', 'العلمين', 'الضبعة', 'النجيلة', 'سيدي براني', 'السلوم', 'سيوة'],
          'البحر الأحمر': ['الغردقة', 'سفاجا', 'القصير', 'رأس غارب', 'الشلاتين', 'حلايب', 'مرسى علم'],
          'الوادي الجديد': ['الخارجة', 'الداخلة', 'الفرافرة', 'باريس', 'بلاط']
        };
        
        let isSubmitting = false;

        let state = {
            cart: [],
            settings: { promoCodes: {}, shippingRates: {}, lenses: {} },
            appliedPromo: { code: null, value: 0, type: null, amount: 0 },
            shippingCost: 0,
            currentStep: 1,
        };

      const getEl = (id) => document.getElementById(id);
const elements = {
    pageLoader: getEl('pageLoader'),
    cartCount: getEl('cartCount'),
    cartCountBottomNav: getEl('cartCountBottomNav'), // << أضف هذا السطر
    mainCartContent: getEl('mainCartContent'),
            orderConfirmation: getEl('orderConfirmation'),
            confirmationMessage: getEl('confirmationMessage'),
            trackingIdDisplay: getEl('trackingIdDisplay'),
            trackOrderBtn: getEl('trackOrderBtn'),
            backToStoreBtn: getEl('backToStoreBtn'),
            confirmationButtons: getEl('confirmationButtons'),
            cartStep1: getEl('cartStep1'),
            cartStep2: getEl('cartStep2'),
            cartItemsContainer: getEl('cartItems'),
            emptyCartMessage: getEl('emptyCartMessage'),
            step1SummaryDetails: getEl('step1SummaryDetails'),
            finalSummary: getEl('finalSummary'),
            promoCodeInput: getEl('promoCode'),
            applyPromoBtn: getEl('applyPromo'),
            promoMessage: getEl('promoMessage'),
            proceedToShippingBtn: getEl('proceedToShipping'),
            backToCartBtn: getEl('backToCart'),
            sendOrderBtn: getEl('sendOrderBtn'),
            customerForm: getEl('customerForm'),
            customerGovernorate: getEl('customerGovernorate'),
            customerDistrict: getEl('customerDistrict'),
            customerAddress: getEl('customerAddress'),
            locateMeBtn: getEl('locateMeBtn'),
            darkModeToggle: getEl('darkModeToggle'),
            lightModeIcon: getEl('lightModeIcon'),
            darkModeIcon: getEl('darkModeIcon'),
            paymentMethodsContainer: getEl('paymentMethodsContainer'),
            instaPayDetails: getEl('instaPayDetails'),
            eWalletDetails: getEl('eWalletDetails'),
            orderError: getEl('orderError'),
            toast: {
                container: getEl('toastNotification'),
                message: getEl('toastMessage'),
                closeBtn: getEl('toastCloseBtn')
            },
            progress: {
                step1: getEl('step1'),
                step2: getEl('step2'),
                fill: document.querySelector('.progress-fill')
            }
        };
        
        let toastTimeout;
        const showToast = (message, type = 'info', duration = 4000) => {
            clearTimeout(toastTimeout);
            elements.toast.message.textContent = message;
            elements.toast.container.className = 'toast-notification'; // Reset classes
            elements.toast.container.classList.add(type, 'show');
            
            toastTimeout = setTimeout(() => {
                elements.toast.container.classList.remove('show');
            }, duration);
        };

        // **MODIFIED** Function to show confirmation screen
        const showConfirmationScreen = (trackingId, isFromSync = false, orderDataForWhatsapp = null) => {
            elements.mainCartContent.style.display = 'none';
            elements.orderConfirmation.style.display = 'block';
            elements.trackingIdDisplay.textContent = trackingId;
            elements.trackOrderBtn.href = `track.html?id=${trackingId}`;

            // Remove any existing resend button to avoid duplicates
            getEl('resendWhatsappBtn')?.remove();

            if (isFromSync) {
                elements.confirmationMessage.innerHTML = 'تمت مزامنة طلبك المعلق بنجاح! نعتذر عن التأخير. <br> يمكنك إرسال تفاصيل الطلب إلى واتساب مرة أخرى إذا أردت.';
                
                if (orderDataForWhatsapp) {
                    const resendButton = document.createElement('a');
                    resendButton.id = 'resendWhatsappBtn';
                    resendButton.className = 'btn btn-success btn-lg';
                    resendButton.innerHTML = '<i class="fab fa-whatsapp me-2"></i> إرسال إلى واتساب';
                    resendButton.target = '_blank'; // Open in a new tab

                    // Reconstruct necessary data for the WhatsApp message
                    const totals = {
                        subtotal: orderDataForWhatsapp.subtotal,
                        discountAmount: orderDataForWhatsapp.discount,
                        total: orderDataForWhatsapp.total
                    };
                    let paymentInfoForMessage = "كاش عند الاستلام";
                    if (orderDataForWhatsapp.paymentMethod?.startsWith('InstaPay')) {
                        paymentInfoForMessage = `انستا باي (${orderDataForWhatsapp.paymentMethod.split(': ')[1] || 'لم يتم إدخاله'})`;
                    } else if (orderDataForWhatsapp.paymentMethod?.startsWith('E-Wallet')) {
                        paymentInfoForMessage = `محفظة إلكترونية (${orderDataForWhatsapp.paymentMethod.split(': ')[1] || 'لم يتم إدخاله'})`;
                    }
                    totals.paymentInfoForMessage = paymentInfoForMessage;

                    const message = generateWhatsappMessage(orderDataForWhatsapp, totals);
                    resendButton.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
                    
                    // Insert the button before the "Track Order" button
                    elements.confirmationButtons.insertBefore(resendButton, elements.trackOrderBtn);
                }
            } else {
                elements.confirmationMessage.textContent = 'شكراً لطلبك من يوسف للبصريات. تم توجيهك إلى واتساب لإرسال تفاصيل الطلب.';
            }

            window.scrollTo(0, 0);
        };
        
        const clearConfirmationState = () => {
            sessionStorage.removeItem('confirmedOrder');
        };

        // **MODIFIED** Main function to run on page load
        const runInitialView = async () => {
            state.cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            // 1. Check for a standard confirmed order (from the same session)
            const confirmedOrder = JSON.parse(sessionStorage.getItem('confirmedOrder'));
            if (confirmedOrder && confirmedOrder.trackingId) {
                showConfirmationScreen(confirmedOrder.trackingId);
                localStorage.removeItem('cart'); // Ensure cart is cleared
                state.cart = [];
                updateCartCount();
                elements.pageLoader.style.display = 'none';
                loadTheme();
                setupEventListeners();
                return; // Stop further execution
            }

            let syncedOrderData = null;
            try {
                // Fetch settings first
                const [shippingDoc, promoDoc, lensesDoc] = await Promise.all([
                    getDoc(doc(db, "settings", "shippingRates")),
                    getDoc(doc(db, "settings", "promocodes")),
                    getDoc(doc(db, "settings", "lenses"))
                ]);
                
                if (shippingDoc.exists()) state.settings.shippingRates = shippingDoc.data();
                if (promoDoc.exists()) state.settings.promoCodes = promoDoc.data();
                if (lensesDoc.exists()) state.settings.lenses = lensesDoc.data();

                // 2. Try to process any pending orders (from a failed submission)
                syncedOrderData = await processPendingOrders();

            } catch (error)
            {
                console.error("Initialization Error:", error);
                showToast("فشل تحميل إعدادات المتجر.", "error");
            } finally {
                elements.pageLoader.style.display = 'none';
            }

            // 3. If a pending order was just synced, show confirmation
            if (syncedOrderData) {
                localStorage.removeItem('cart'); // CRITICAL: Clear the main cart
                state.cart = [];
                updateCartCount();
                
                showConfirmationScreen(syncedOrderData.trackingId, true, syncedOrderData);
                
                loadTheme();
                setupEventListeners();
                return; // Stop further execution
            }
            
            // 4. If no confirmed or synced order, proceed with normal cart display
            populateGovernorates();
            loadTheme();
            setupEventListeners();
            
            if (state.cart.length === 0) {
                showEmptyCart();
            } else {
                renderUI();
            }
        };
        
        const populateGovernorates = () => {
            const select = elements.customerGovernorate;
            select.innerHTML = '<option value="">اختر المحافظة</option>';
            if (state.settings.shippingRates) {
                const sortedGovernorates = Object.keys(state.settings.shippingRates).sort();
                sortedGovernorates.forEach(gov => {
                    const option = document.createElement('option');
                    option.value = gov;
                    option.textContent = gov;
                    select.appendChild(option);
                });
            }
        };

        const renderUI = () => {
            updateCartCount();
            updateProgressIndicator();
            if (state.currentStep === 1) {
                elements.cartStep1.style.display = 'block';
                elements.cartStep2.classList.add('d-none');
                renderCartItems();
                renderSummary(elements.step1SummaryDetails);
            } else {
                elements.cartStep1.style.display = 'none';
                elements.cartStep2.classList.remove('d-none');
                renderSummary(elements.finalSummary);
            }
        };
        
        const renderCartItems = () => {
            if (state.cart.length === 0) {
                showEmptyCart();
                return;
            }
            elements.cartItemsContainer.innerHTML = state.cart.map((item, index) => {
                const lensType = item.options?.lensType;
                const lensPrice = lensType && state.settings.lenses ? parseFloat(state.settings.lenses[lensType] || 0) : 0;
                const totalItemPrice = parseFloat(item.price || 0);
                const framePrice = totalItemPrice - lensPrice;
                const totalLinePrice = totalItemPrice * item.quantity;

                state.cart[index].lensPrice = lensPrice;
                state.cart[index].framePrice = framePrice;
                
                let priceDetailsHTML = '';
                if (lensPrice > 0) {
                    priceDetailsHTML = `
                        <div class="price-breakdown">
                            <div>سعر الإطار: ${framePrice.toFixed(2)} ج.م</div>
                            <div>عدسات (${lensType}): ${lensPrice.toFixed(2)} ج.م</div>
                            <div class="fw-bold mt-1">سعر القطعة: ${totalItemPrice.toFixed(2)} ج.م</div>
                        </div>
                    `;
                } else {
                     priceDetailsHTML = `
                        <div class="price-breakdown">
                            <div class="fw-bold">سعر القطعة: ${totalItemPrice.toFixed(2)} ج.م</div>
                        </div>
                    `;
                }

                return `
                    <div class="cart-item" data-index="${index}">
                        <div class="cart-item-details">
                            <h4 class="fw-bold fs-6 mb-1">${item.name}</h4>
                            ${priceDetailsHTML}
                            <div class="d-flex align-items-center justify-content-between mt-3">
                                <div class="quantity-control">
                                    <button class="quantity-btn decrease-qty">-</button>
                                    <input type="number" value="${item.quantity}" class="quantity-input" min="1">
                                    <button class="quantity-btn increase-qty">+</button>
                                </div>
                                <button class="btn p-0 remove-item text-danger fs-5"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <p class="fs-5 fw-bold mt-3 pt-2 border-top border-secondary-subtle mb-0">
                                إجمالي المنتج: <span style="color: var(--yello);">${totalLinePrice.toFixed(2)} ج.م</span>
                            </p>
                        </div>
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/eee/ccc?text=Error';">
                    </div>
                `;
            }).join('');
            saveCart();
        };

        const renderSummary = (container) => {
            const { subtotal, discountAmount, total } = calculateTotals();
            container.innerHTML = `
                <div class="d-flex justify-content-between py-1"><span>المجموع الفرعي</span><span>${subtotal.toFixed(2)} ج.م</span></div>
                <div class="d-flex justify-content-between py-1"><span>الشحن</span><span id="shippingCostDisplay">${state.shippingCost > 0 ? state.shippingCost.toFixed(2) + ' ج.م' : 'سيتم تحديده'}</span></div>
                ${discountAmount > 0 ? `<div class="d-flex justify-content-between py-1 text-success"><span>الخصم (${state.appliedPromo.code})</span><span>-${discountAmount.toFixed(2)} ج.م</span></div>` : ''}
                <div class="d-flex justify-content-between fw-bold fs-5 pt-2 mt-2 border-top">
                    <span>الإجمالي</span>
                    <span>${total.toFixed(2)} ج.م</span>
                </div>
            `;
        };
        
        const updateProgressIndicator = () => {
            if(state.currentStep === 1) {
                elements.progress.step1.classList.add('active');
                elements.progress.step1.classList.remove('completed');
                elements.progress.step2.classList.remove('active', 'completed');
                elements.progress.fill.style.width = '0%';
            } else {
                elements.progress.step1.classList.remove('active');
                elements.progress.step1.classList.add('completed');
                elements.progress.step2.classList.add('active');
                elements.progress.fill.style.width = '100%';
            }
        };
        
        const showEmptyCart = () => {
            elements.mainCartContent.style.display = 'block';
            elements.orderConfirmation.style.display = 'none';
            elements.cartStep1.style.display = 'none';
            elements.cartStep2.classList.add('d-none');
            elements.emptyCartMessage.style.display = 'block';
            document.querySelector('.progress-steps')?.style.setProperty('display', 'none', 'important');
        };

        const updateCartCount = () => {
    const count = state.cart.reduce((acc, item) => acc + item.quantity, 0);

    // تحديث عداد النافبار العلوي (الكود الحالي)
    elements.cartCount.textContent = count;

    // --- ابدأ التعديل من هنا ---
    // تحديث عداد النافبار السفلي
    if (elements.cartCountBottomNav) {
        elements.cartCountBottomNav.textContent = count;
        if (count > 0) {
            // إظهار الشارة إذا كانت السلة تحتوي على منتجات
            elements.cartCountBottomNav.style.display = 'flex'; 
        } else {
            // إخفاء الشارة إذا كانت السلة فارغة
            elements.cartCountBottomNav.style.display = 'none';
        }
    }
    // --- انتهى التعديل ---

    if(elements.proceedToShippingBtn) {
       elements.proceedToShippingBtn.disabled = count === 0;
    }
};

        const addInputFilter = (element, regex) => {
            if (element) {
                element.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    const newValue = originalValue.replace(regex, '');
                    if (originalValue !== newValue) {
                        e.target.value = newValue;
                    }
                });
            }
        };

        const addPrescriptionInputFilter = (element) => {
            if (element) {
                element.addEventListener('input', (e) => {
                    const oldValue = e.target.value;
                    let newValue = oldValue;

                    newValue = newValue.replace(/[^0-9.-]/g, '');

                    if (newValue.indexOf('-', 1) > 0) {
                         newValue = newValue.charAt(0) + newValue.slice(1).replace(/-/g, "");
                    }
                    
                    const dotIndex = newValue.indexOf('.');
                    if (dotIndex !== -1) {
                        const restOfString = newValue.substring(dotIndex + 1);
                        newValue = newValue.substring(0, dotIndex + 1) + restOfString.replace(/\./g, '');
                    }

                    if (oldValue !== newValue) {
                        e.target.value = newValue;
                    }
                });
            }
        };

        const setupEventListeners = () => {
            elements.darkModeToggle?.addEventListener('click', toggleTheme);
            elements.proceedToShippingBtn?.addEventListener('click', () => { state.currentStep = 2; renderUI(); });
            elements.backToCartBtn?.addEventListener('click', () => { state.currentStep = 1; renderUI(); });
            elements.applyPromoBtn?.addEventListener('click', applyPromoCode);
            elements.customerGovernorate?.addEventListener('change', handleGovernorateChange);
            elements.locateMeBtn?.addEventListener('click', handleLocateMe);
            elements.cartItemsContainer?.addEventListener('click', handleCartActions);
            elements.cartItemsContainer?.addEventListener('input', handleCartActions);
            elements.sendOrderBtn?.addEventListener('click', handleFormSubmit);
            elements.toast.closeBtn?.addEventListener('click', () => elements.toast.container.classList.remove('show'));
            elements.backToStoreBtn?.addEventListener('click', clearConfirmationState);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    const confirmedOrder = JSON.parse(sessionStorage.getItem('confirmedOrder'));
                    if (confirmedOrder && confirmedOrder.trackingId) {
                        showConfirmationScreen(confirmedOrder.trackingId);
                    }
                }
            });

            elements.paymentMethodsContainer.addEventListener('change', (e) => {
                if (e.target.name === 'paymentMethod') {
                    document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('active'));
                    e.target.closest('.payment-option').classList.add('active');

                    elements.instaPayDetails.classList.add('d-none');
                    elements.eWalletDetails.classList.add('d-none');

                    if (e.target.value === 'InstaPay') {
                        elements.instaPayDetails.classList.remove('d-none');
                    } else if (e.target.value === 'E-Wallet') {
                        elements.eWalletDetails.classList.remove('d-none');
                    }
                }
            });

            addInputFilter(getEl('customerPhone'), /[^0-9]/g);
            addInputFilter(getEl('eWalletNumber'), /[^0-9]/g);
            addInputFilter(getEl('instaPayHandle'), /[^a-zA-Z0-9@.]/g);

            const prescriptionInputs = [
                'ipdDistance', 'leftAxisDistance', 'leftCylinderDistance', 'leftSphereDistance',
                'rightAxisDistance', 'rightCylinderDistance', 'rightSphereDistance',
                'ipdReading', 'leftAxisReading', 'leftCylinderReading', 'leftSphereReading',
                'rightAxisReading', 'rightCylinderReading', 'rightSphereReading'
            ];
            prescriptionInputs.forEach(id => {
                const el = getEl(id);
                if (el) {
                    addPrescriptionInputFilter(el);
                }
            });
        };

        const handleCartActions = (e) => {
            const target = e.target;
            const itemElement = target.closest('.cart-item');
            if (!itemElement) return;
            const index = parseInt(itemElement.dataset.index);

            if (target.matches('.increase-qty')) state.cart[index].quantity++;
            else if (target.matches('.decrease-qty') && state.cart[index].quantity > 1) state.cart[index].quantity--;
            else if (target.matches('.remove-item, .remove-item *')) state.cart.splice(index, 1);
            else if (target.matches('.quantity-input')) {
                const newQty = parseInt(target.value);
                state.cart[index].quantity = newQty > 0 ? newQty : 1;
            }
            saveCart();
            renderUI();
        };

        const applyPromoCode = () => {
            const code = elements.promoCodeInput.value.trim().toUpperCase();
            const promo = state.settings.promoCodes[code];

            if (promo && promo.active && new Date(promo.expiresAt.seconds * 1000) > new Date() && promo.used < promo.maxUses) {
                state.appliedPromo.code = code;
                elements.promoMessage.textContent = 'تم تطبيق الخصم بنجاح!';
                elements.promoMessage.className = 'p-3 rounded-3 text-success-emphasis bg-success-subtle border border-success-subtle';
            } else {
                state.appliedPromo.code = null;
                elements.promoMessage.textContent = 'كود الخصم غير صحيح أو منتهي الصلاحية.';
                elements.promoMessage.className = 'p-3 rounded-3 text-danger-emphasis bg-danger-subtle border border-danger-subtle';
            }
            elements.promoMessage.classList.remove('d-none');
            renderUI();
        };
        
        const handleGovernorateChange = (e) => {
            const governorateName = e.target.value;
            state.shippingCost = parseFloat(state.settings.shippingRates[governorateName] || 0);

            const districtSelect = elements.customerDistrict;
            districtSelect.innerHTML = '<option value="">اختر الحي</option>';
            if (governorateName && districts[governorateName]) {
                districts[governorateName].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
                districtSelect.disabled = false;
            } else {
                districtSelect.disabled = true;
            }
            renderUI();
        };

        const displayOrderError = (message) => {
            elements.orderError.textContent = message;
            elements.orderError.classList.remove('d-none');
        };

        const hideOrderError = () => {
            elements.orderError.classList.add('d-none');
        };
        
        const saveOrderToFirestore = async (orderData) => {
            return runTransaction(db, async (transaction) => {
                const orderRef = doc(collection(db, "orders"));
        
                const productRefs = orderData.products.map(item => doc(db, "products", item.productId));
                const productDocs = await Promise.all(productRefs.map(ref => transaction.get(ref)));
        
                for (let i = 0; i < productDocs.length; i++) {
                    const productDoc = productDocs[i];
                    const item = orderData.products[i];
        
                    if (!productDoc.exists()) {
                        throw new Error(`عذراً، المنتج "${item.name}" لم يعد متوفراً.`);
                    }
        
                    const currentStock = productDoc.data().stock;
                    if (typeof currentStock !== 'number' || currentStock < item.quantity) {
                        throw new Error(`الكمية المطلوبة للمنتج "${item.name}" غير متوفرة. المتاح حالياً: ${currentStock || 0}`);
                    }
                }
        
                orderData.products.forEach((item, index) => {
                    const productRef = productRefs[index];
                    transaction.update(productRef, { stock: increment(-item.quantity) });
                });
        
                if (orderData.promoCode) {
                    const promoRef = doc(db, "settings", "promocodes");
                    const promoFieldToUpdate = `${orderData.promoCode}.used`;
                    transaction.update(promoRef, { [promoFieldToUpdate]: increment(1) });
                }
        
                transaction.set(orderRef, orderData);
            });
        };
        
        const saveOrderLocally = (orderData) => {
            const pendingOrders = JSON.parse(localStorage.getItem('pendingOrders')) || [];
            if (!pendingOrders.some(o => o.trackingId === orderData.trackingId)) {
                pendingOrders.push(orderData);
                localStorage.setItem('pendingOrders', JSON.stringify(pendingOrders));
            }
        };

        const clearPendingOrder = (trackingId) => {
            let pendingOrders = JSON.parse(localStorage.getItem('pendingOrders')) || [];
            pendingOrders = pendingOrders.filter(o => o.trackingId !== trackingId);
            if (pendingOrders.length > 0) {
                localStorage.setItem('pendingOrders', JSON.stringify(pendingOrders));
            } else {
                localStorage.removeItem('pendingOrders');
            }
        };

        // **MODIFIED** Function to process pending orders on page load
        const processPendingOrders = async () => {
            const pendingOrders = JSON.parse(localStorage.getItem('pendingOrders')) || [];
            if (pendingOrders.length === 0) return null;

            console.log(`Found ${pendingOrders.length} pending orders. Attempting to sync...`);
            showToast(`جاري مزامنة طلبك المعلق...`, 'info', 5000);

            const localOrderData = pendingOrders[0]; // Process one by one

            try {
                const orderToSend = { ...localOrderData, date: serverTimestamp() };
                await saveOrderToFirestore(orderToSend);
                
                console.log(`Successfully synced order ${localOrderData.trackingId}`);
                clearPendingOrder(localOrderData.trackingId);
                
                // Return the full synced order object so the UI can use it
                return localOrderData; 

            } catch (error) {
                console.error(`Failed to sync pending order ${localOrderData.trackingId}:`, error);
                const isStockError = error.message.includes("الكمية المطلوبة") || error.message.includes("لم يعد متوفراً");
                
                const userMessage = isStockError
                    ? `فشلت مزامنة الطلب المعلق (${localOrderData.trackingId}): ${error.message}. تم حذف الطلب المعلق، يرجى مراجعة سلتك والمحاولة مرة أخرى.`
                    : 'فشل مزامنة الطلب المعلق. سيتم المحاولة لاحقاً.';
                
                if (isStockError) {
                    clearPendingOrder(localOrderData.trackingId); // Remove the problematic order
                }
                
                showToast(userMessage, 'error', 8000);
                return null;
            }
        };
        
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            hideOrderError();

            if (isSubmitting) return;

            if (!elements.customerForm.checkValidity()) {
                elements.customerForm.classList.add('was-validated');
                showToast('يرجى ملء جميع الحقول المطلوبة.', 'error');
                return;
            }
            
            isSubmitting = true;
            toggleButtonLoading(true);

            const { subtotal, discountAmount, total } = calculateTotals();
            const trackingId = `YOU-${Math.floor(100000000 + Math.random() * 900000000)}`;
            
            const prescription = {
                distance: {
                    right: { sph: getEl('rightSphereDistance').value, cyl: getEl('rightCylinderDistance').value, axis: getEl('rightAxisDistance').value },
                    left: { sph: getEl('leftSphereDistance').value, cyl: getEl('leftCylinderDistance').value, axis: getEl('leftAxisDistance').value },
                    ipd: getEl('ipdDistance').value
                },
                reading: {
                    right: { sph: getEl('rightSphereReading').value, cyl: getEl('rightCylinderReading').value, axis: getEl('rightAxisReading').value },
                    left: { sph: getEl('leftSphereReading').value, cyl: getEl('leftCylinderReading').value, axis: getEl('leftAxisReading').value },
                    ipd: getEl('ipdReading').value
                }
            };

            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            let paymentDetails = selectedPaymentMethod;
            let paymentInfoForMessage = "كاش عند الاستلام";

            if (selectedPaymentMethod === 'InstaPay') {
                const handle = getEl('instaPayHandle').value;
                paymentDetails = `InstaPay: ${handle}`;
                paymentInfoForMessage = `انستا باي (${handle || 'لم يتم إدخاله'})`;
            } else if (selectedPaymentMethod === 'E-Wallet') {
                const number = getEl('eWalletNumber').value;
                paymentDetails = `E-Wallet: ${number}`;
                paymentInfoForMessage = `محفظة إلكترونية (${number || 'لم يتم إدخاله'})`;
            }
            
            const productsForFirestore = state.cart.map(item => ({
                productId: item.baseId || item.id, 
                name: item.name,
                quantity: item.quantity,
                image: item.image,
                options: item.options || {},
                pricePerUnit: item.price || 0,
                framePrice: item.framePrice || 0,
                lensPrice: item.lensPrice || 0,
            }));

            const orderData = {
                trackingId,
                customerName: getEl('customerName').value,
                customerPhone: getEl('customerPhone').value,
                governorate: getEl('customerGovernorate').value,
                district: getEl('customerDistrict').value,
                address: getEl('customerAddress').value,
                fullAddress: `${getEl('customerGovernorate').value} - ${getEl('customerDistrict').value} - ${getEl('customerAddress').value}`,
                notes: getEl('customerNotes').value,
                paymentMethod: paymentDetails,
                paymentStatus: 'لم يتم الدفع',
                orderStatus: 'تم الطلب',
                products: productsForFirestore,
                subtotal,
                discount: discountAmount,
                promoCode: state.appliedPromo.code || null,
                shipping: state.shippingCost,
                total,
                prescription,
                date: serverTimestamp() 
            };
            
            const messageForWhatsapp = generateWhatsappMessage(orderData, { subtotal, discountAmount, total, paymentInfoForMessage });
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(messageForWhatsapp)}`;
            
            try {
                const itemsWithoutId = productsForFirestore.filter(p => !p.productId);
                if (itemsWithoutId.length > 0) {
                    const productNames = itemsWithoutId.map(p => p.name).join(', ');
                    throw new Error(`خطأ فني: المنتج (${productNames}) ليس له معرّف صالح. يرجى حذفه من السلة وإضافته مرة أخرى.`);
                }

                await saveOrderToFirestore(orderData);
                console.log(`Order ${trackingId} saved to Firestore successfully.`);
                clearPendingOrder(trackingId);

                localStorage.removeItem('cart');
                state.cart = [];
                updateCartCount();
                
                sessionStorage.setItem('confirmedOrder', JSON.stringify({ trackingId: trackingId }));

                showToast('تم تأكيد طلبك! سيتم توجيهك إلى واتساب الآن...', 'success');
                setTimeout(() => {
                    window.location.href = whatsappUrl + '&_=' + Date.now();
                }, 1000);

            } catch (error) {
                console.error("🔥 Firestore Order Submission Failed! 🔥", error);
                const isStockError = error.message.includes("الكمية المطلوبة") || error.message.includes("لم يعد متوفراً");
                
                const userMessage = isStockError
                    ? error.message
                    : "حدث خطأ أثناء تأكيد الطلب. سيتم حفظ طلبك مؤقتاً.";
                displayOrderError(userMessage);
                
                if (isStockError) {
                    isSubmitting = false;
                    toggleButtonLoading(false);
                } else {
                    const { date, ...localOrderData } = orderData;
                    saveOrderLocally(localOrderData);
                    displayOrderError("حدث خطأ في الاتصال. تم حفظ طلبك وسنحاول إرساله لاحقاً عند عودة الاتصال.");
                    // Keep button disabled to prevent retries on the same broken order.
                }
            }
        };
        
        // **REFACTORED** This function now ONLY uses the orderData object, not the DOM.
        function generateWhatsappMessage(orderData, totals) {
             let message = `*طلب جديد من موقع - يوسف للبصريات*\n\n` +
                `*العميل:* ${orderData.customerName}\n` +
                `*الهاتف:* ${orderData.customerPhone}\n` +
                `*العنوان:* ${orderData.governorate} - ${orderData.district}\n` +
                `*تفاصيل العنوان:* ${orderData.address}\n` +
                `*طريقة الدفع:* ${totals.paymentInfoForMessage}\n`;
            
             if (orderData.notes) {
                message += `\n*ملاحظات:* ${orderData.notes}\n`;
            }

            message += `\n*الطلبات:*\n`;
            orderData.products.forEach(item => {
                const totalLinePrice = (item.pricePerUnit * item.quantity).toFixed(2);
                message += `\n- *${item.name}* (الكمية: ${item.quantity}) | الإجمالي: *${totalLinePrice} ج.م*\n`;
                
                if (item.lensPrice && item.lensPrice > 0) {
                    message += `  • _تفاصيل السعر للقطعة:_\n`;
                    message += `    › _الإطار: ${item.framePrice.toFixed(2)} ج.م_\n`;
                    message += `    › _العدسات (${item.options.lensType}): ${item.lensPrice.toFixed(2)} ج.م_\n`;
                } else {
                    message += `  • _السعر للقطعة: ${item.pricePerUnit.toFixed(2)} ج.م_\n`;
                }
            });

            const p = orderData.prescription;
            const hasDistanceData = p && p.distance && (p.distance.right.sph || p.distance.right.cyl || p.distance.right.axis || p.distance.left.sph || p.distance.left.cyl || p.distance.left.axis || p.distance.ipd);
            const hasReadingData = p && p.reading && (p.reading.right.sph || p.reading.right.cyl || p.reading.right.axis || p.reading.left.sph || p.reading.left.cyl || p.reading.left.axis || p.reading.ipd);

            if (hasDistanceData || hasReadingData) {
                let prescriptionMessage = `\n\n*📝 مقاس النظر:*\n`;
                prescriptionMessage += `──────────────────\n`;
                if (hasDistanceData) {
                    prescriptionMessage += `*👓 للمسافات البعيدة (Distance):*\n`;
                    prescriptionMessage += `→ العين اليمنى: SPH: ${p.distance.right.sph || '--'}, CYL: ${p.distance.right.cyl || '--'}, AXIS: ${p.distance.right.axis || '--'}\n`;
                    prescriptionMessage += `→ العين اليسرى: SPH: ${p.distance.left.sph || '--'}, CYL: ${p.distance.left.cyl || '--'}, AXIS: ${p.distance.left.axis || '--'}\n`;
                    if (p.distance.ipd) {
                        prescriptionMessage += `→ المسافة (IPD): ${p.distance.ipd}\n`;
                    }
                    prescriptionMessage += `──────────────────\n`;
                }
                if (hasReadingData) {
                    prescriptionMessage += `*📖 للقراءة (Reading):*\n`;
                    prescriptionMessage += `→ العين اليمنى: SPH: ${p.reading.right.sph || '--'}, CYL: ${p.reading.right.cyl || '--'}, AXIS: ${p.reading.right.axis || '--'}\n`;
                    prescriptionMessage += `→ العين اليسرى: SPH: ${p.reading.left.sph || '--'}, CYL: ${p.reading.left.cyl || '--'}, AXIS: ${p.reading.left.axis || '--'}\n`;
                    if (p.reading.ipd) {
                        prescriptionMessage += `→ المسافة (IPD): ${p.reading.ipd}\n`;
                    }
                }
                message += prescriptionMessage;
            }

            message += `\n\n*تفاصيل الدفع:*\n` +
                                 `إجمالي المنتجات: ${totals.subtotal.toFixed(2)} ج.م\n`;
            if (totals.discountAmount > 0 && orderData.promoCode) {
                message += `الخصم (${orderData.promoCode}): -${totals.discountAmount.toFixed(2)} ج.م\n` +
                                     `الإجمالي بعد الخصم: ${(totals.subtotal - totals.discountAmount).toFixed(2)} ج.م\n`;
            }
            message += `رسوم الشحن: ${orderData.shipping.toFixed(2)} ج.م\n` +
                                 `*المبلغ الإجمالي: ${totals.total.toFixed(2)} ج.م*\n\n` +
                                 `*رقم التتبع:* \`${orderData.trackingId}\`\n`; 
            message += `يمكنك متابعة الطلب من الرابط:\n${window.location.origin}/track.html?id=${orderData.trackingId}\n\n` +
            `شكراً لثقتك بنا! ❤️`;

            return message;
        }
        
        const calculateTotals = () => {
            const subtotal = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            let discountAmount = 0;
            if (state.appliedPromo.code) {
                const promo = state.settings.promoCodes[state.appliedPromo.code.toUpperCase()];
                if (promo) {
                    discountAmount = promo.type === 'percentage' ? subtotal * (promo.value / 100) : parseFloat(promo.value);
                }
            }
            const total = subtotal - discountAmount + state.shippingCost;
            return { subtotal, discountAmount, total };
        };

        const toggleButtonLoading = (isLoading, button = elements.sendOrderBtn) => {
            if (!button) return;
            const btnText = button.querySelector('.btn-text');
            const btnLoader = button.querySelector('.btn-loader');
            if (isLoading) {
                button.disabled = true;
                if(btnText) btnText.style.display = 'none';
                if(btnLoader) btnLoader.classList.remove('d-none');
            } else {
                button.disabled = false;
                if(btnText) btnText.style.display = 'inline-block';
                if(btnLoader) btnLoader.classList.add('d-none');
            }
        };
        
        const loadTheme = () => { 
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            const moon = elements.darkModeIcon;
            const sun = elements.lightModeIcon;
            if (theme === 'dark') {
                moon.classList.remove('d-none');
                sun.classList.add('d-none');
            } else {
                moon.classList.add('d-none');
                sun.classList.remove('d-none');
            }
        };
        
        const toggleTheme = () => {
            const newTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            loadTheme();
        };

        const saveCart = () => localStorage.setItem('cart', JSON.stringify(state.cart)); 

        const handleLocateMe = () => {
            if (navigator.geolocation) {
                elements.locateMeBtn.disabled = true;
                elements.locateMeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري...';
                navigator.geolocation.getCurrentPosition(handleLocationSuccess, handleLocationError, { enableHighAccuracy: true });
            } else {
                showToast("المتصفح الخاص بك لا يدعم تحديد الموقع.", 'error');
            }
        };

        const handleLocationError = (error) => {
            elements.locateMeBtn.disabled = false;
            elements.locateMeBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i> استخدام موقعي الحالي';
            showToast("حدث خطأ أثناء تحديد موقعك. يرجى السماح بالوصول للموقع.", 'error');
        };

        async function handleLocationSuccess(position) {
            const { latitude, longitude } = position.coords;
            const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ar`;
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data && data.address) {
                    const addr = data.address;
                    const governorateName = addr.state || addr.governorate || '';
                    const districtName = addr.city || addr.town || addr.village || addr.suburb || addr.city_district || '';
                    const streetName = addr.road || addr.neighbourhood || '';
                    
                    const wasGovFound = findAndSelectOption(elements.customerGovernorate, governorateName);
                    if (wasGovFound) {
                        setTimeout(() => findAndSelectOption(elements.customerDistrict, districtName), 700);
                    }
                    
                    elements.customerAddress.value = streetName;
                    showToast("تم تحديد عنوانك بنجاح! يرجى مراجعته.", 'success');
                } else {
                    showToast("لم نتمكن من تحويل موقعك إلى عنوان.", 'error');
                }
            } catch (err) {
                console.error("Geocoding Error:", err);
                showToast("فشل الاتصال بخدمة تحديد العناوين.", 'error');
            } finally {
                elements.locateMeBtn.disabled = false;
                elements.locateMeBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i> استخدام موقعي الحالي';
            }
        }

        function findAndSelectOption(selectElement, nameToFind) {
            if (!selectElement || !nameToFind) return false;
            const cleanedNameToFind = nameToFind.replace('محافظة', '').trim();
            const optionToSelect = Array.from(selectElement.options).find(opt => {
                const cleanedOptionText = opt.textContent.replace(/ \(.+?\)/, '').replace('محافظة', '').trim();
                return cleanedOptionText === cleanedNameToFind || opt.value === cleanedNameToFind;
            });
            if (optionToSelect) {
                selectElement.value = optionToSelect.value;
                selectElement.dispatchEvent(new Event('change'));
                return true;
            }
            return false;
        }





        // --- Start the application logic ---
        runInitialView();

        // Handle page show event for back-forward cache
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                console.log("Page loaded from BFCache. Re-running view logic.");
                isSubmitting = false; // Reset submitting state on page show
                toggleButtonLoading(false); // Ensure button is enabled
                runInitialView();
            }
        });
    });
</script>
</body>
</html>
